name: Build and Deploy Package to R2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'packages/package/**'
      - '.github/workflows/build-and-deploy-package.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git describe
          fetch-tags: true  # Fetch all tags for version detection

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Generate version tag
        id: version
        shell: bash
        run: |
          # Fetch all tags from remote
          git fetch --tags --force
          
          # Get all version tags and find the latest
          LATEST_TAG=$(git tag --list "v*" | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -1)
          
          echo "All version tags:"
          git tag --list "v*" | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V || echo "No tags found"
          
          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, use package.json version as starting point
            BASE_VERSION=$(node -p "require('./packages/package/package.json').version")
            VERSION_TAG="v${BASE_VERSION}"
            echo "No existing tags found, using package.json version: ${VERSION_TAG}"
          else
            # Extract version from latest tag (remove 'v' prefix)
            LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
            
            # Increment patch version from the latest tag
            IFS='.' read -r -a VERSION_PARTS <<< "$LATEST_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Ensure PATCH is a number (handle edge cases)
            if [ -z "$PATCH" ] || ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
              PATCH=0
            fi
            
            NEW_PATCH=$((PATCH + 1))
            VERSION_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "Latest tag: ${LATEST_TAG}, incrementing to: ${VERSION_TAG}"
          fi
          
          echo "version=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "✅ Generated version: ${VERSION_TAG}"

      - name: Install dependencies
        run: bun install

      - name: Build package
        working-directory: packages/package
        run: bun run build

      - name: Create release archive
        run: |
          cd packages/package/dist
          tar -czf ../release-archive.tar.gz *
          zip -r ../release-archive.zip *
          cd ../..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Package Release ${{ steps.version.outputs.version }}
            
            Built from commit: ${{ github.sha }}
            
            ### Files
            - `opencomments.js` - Main bundle
            - `opencomments.js.map` - Source map
            - `opencomments.css` - Stylesheet
            
            ### Installation
            ```html
            <link rel="stylesheet" href="${{ secrets.R2_ENDPOINT }}/${{ steps.version.outputs.version }}/opencomments.css">
            <script src="${{ secrets.R2_ENDPOINT }}/${{ steps.version.outputs.version }}/opencomments.js"></script>
            ```
          files: |
            packages/package/release-archive.tar.gz
            packages/package/release-archive.zip
          draft: false
          prerelease: false

      - name: Configure AWS CLI for R2
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}" >> ~/.aws/credentials
          echo "aws_secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = auto" >> ~/.aws/config

      - name: Upload to Cloudflare R2 (versioned)
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          VERSION_TAG: ${{ steps.version.outputs.version }}
        run: |
          # Install AWS CLI if not available
          if ! command -v aws &> /dev/null; then
            pip install awscli
          fi
          
          # Debug: Print version info
          echo "Version tag: ${VERSION_TAG}"
          echo "R2 Bucket: ${R2_BUCKET}"
          echo "R2 Endpoint: ${R2_ENDPOINT}"
          
          # Upload files to R2 using S3-compatible API with version tag
          cd packages/package/dist
          
          # List files to upload
          echo "Files to upload:"
          ls -la
          
          # Upload each file to versioned path
          for file in *; do
            if [ -f "$file" ]; then
              VERSIONED_PATH="s3://${R2_BUCKET}/${VERSION_TAG}/${file}"
              LATEST_PATH="s3://${R2_BUCKET}/latest/${file}"
              
              echo "Uploading ${file} to ${VERSIONED_PATH}"
              aws s3 cp "$file" "${VERSIONED_PATH}" \
                --endpoint-url="${R2_ENDPOINT}" \
                --region auto
              
              echo "Uploading ${file} to ${LATEST_PATH}"
              aws s3 cp "$file" "${LATEST_PATH}" \
                --endpoint-url="${R2_ENDPOINT}" \
                --region auto
            fi
          done
          
          echo "✅ Upload complete"
          echo "Versioned URL: ${R2_ENDPOINT}/${VERSION_TAG}/"
          echo "Latest URL: ${R2_ENDPOINT}/latest/"

      - name: Output deployment info
        run: |
          echo "✅ Package built and deployed to R2"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Bucket: ${{ secrets.R2_BUCKET }}"
          echo "Versioned path: ${{ secrets.R2_BUCKET }}/${{ steps.version.outputs.version }}/"
          echo "Latest path: ${{ secrets.R2_BUCKET }}/latest/"

