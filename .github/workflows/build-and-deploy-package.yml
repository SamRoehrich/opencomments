name: Build and Deploy Package to S3

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git describe
          fetch-tags: true  # Fetch all tags for version detection

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Generate version tag
        id: version
        shell: bash
        run: |
          # Fetch all tags from remote
          git fetch --tags --force
          
          # Get all version tags and find the latest
          LATEST_TAG=$(git tag --list "v*" | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -1)
          
          echo "All version tags:"
          git tag --list "v*" | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V || echo "No tags found"
          
          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, use package.json version as starting point
            BASE_VERSION=$(node -p "require('./packages/package/package.json').version")
            VERSION_TAG="v${BASE_VERSION}"
            echo "No existing tags found, using package.json version: ${VERSION_TAG}"
          else
            # Extract version from latest tag (remove 'v' prefix)
            LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
            
            # Increment patch version from the latest tag
            IFS='.' read -r -a VERSION_PARTS <<< "$LATEST_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Ensure PATCH is a number (handle edge cases)
            if [ -z "$PATCH" ] || ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
              PATCH=0
            fi
            
            NEW_PATCH=$((PATCH + 1))
            VERSION_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "Latest tag: ${LATEST_TAG}, incrementing to: ${VERSION_TAG}"
          fi
          
          echo "version=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "âœ… Generated version: ${VERSION_TAG}"

      - name: Install dependencies
        run: bun install

      - name: Build package
        working-directory: packages/package
        run: bun run build

      - name: Create release archive
        run: |
          cd packages/package/dist
          tar -czf ../release-archive.tar.gz *
          zip -r ../release-archive.zip *
          cd ../..

      - name: Generate release body
        id: release-body
        env:
          CDN_DOMAIN: ${{ secrets.CDN_DOMAIN }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_BASE_PATH: ${{ secrets.S3_BASE_PATH || '' }}
        run: |
          BASE_PATH="${S3_BASE_PATH:+${S3_BASE_PATH}/}"
          if [ -n "$CDN_DOMAIN" ]; then
            BASE_URL="https://${CDN_DOMAIN}/${BASE_PATH}"
          else
            BASE_URL="https://${S3_BUCKET}.s3.amazonaws.com/${BASE_PATH}"
          fi
          
          cat << EOF > /tmp/release-body.md
          ## Package Release ${{ steps.version.outputs.version }}
          
          Built from commit: ${{ github.sha }}
          
          ### Files
          - \`opencomments.js\` - Main bundle
          - \`opencomments.js.map\` - Source map
          - \`opencomments.css\` - Stylesheet
          
          ### Installation
          
          **Latest version:**
          \`\`\`html
          <link rel="stylesheet" href="${BASE_URL}latest/opencomments.css">
          <script src="${BASE_URL}latest/opencomments.js"></script>
          \`\`\`
          
          **Versioned (recommended for production):**
          \`\`\`html
          <link rel="stylesheet" href="${BASE_URL}${{ steps.version.outputs.version }}/opencomments.css">
          <script src="${BASE_URL}${{ steps.version.outputs.version }}/opencomments.js"></script>
          \`\`\`
          EOF
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release-body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.release-body.outputs.body }}
          files: |
            packages/package/release-archive.tar.gz
            packages/package/release-archive.zip
          draft: false
          prerelease: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Upload to S3 (versioned and latest)
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_BASE_PATH: ${{ secrets.S3_BASE_PATH || '' }}
          VERSION_TAG: ${{ steps.version.outputs.version }}
        run: |
          cd packages/package/dist
          
          echo "Files to upload:"
          ls -la
          
          # Set base path (with trailing slash if provided)
          BASE_PATH="${S3_BASE_PATH:+${S3_BASE_PATH}/}"
          
          # Upload each file to versioned path
          for file in *; do
            if [ -f "$file" ]; then
              VERSIONED_PATH="s3://${S3_BUCKET}/${BASE_PATH}${VERSION_TAG}/${file}"
              LATEST_PATH="s3://${S3_BUCKET}/${BASE_PATH}latest/${file}"
              
              echo "Uploading ${file} to ${VERSIONED_PATH}"
              aws s3 cp "$file" "${VERSIONED_PATH}" --cache-control "public, max-age=31536000, immutable"
              
              echo "Uploading ${file} to ${LATEST_PATH}"
              aws s3 cp "$file" "${LATEST_PATH}" --cache-control "public, max-age=3600"
            fi
          done
          
          echo "âœ… Upload complete"

      - name: Set S3 bucket website configuration (if needed)
        if: ${{ secrets.S3_BUCKET_WEBSITE == 'true' }}
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          # Enable static website hosting if bucket is configured for it
          aws s3 website s3://${S3_BUCKET}/ \
            --index-document index.html \
            --error-document error.html || echo "Website config already set or not needed"

      - name: Invalidate CloudFront cache (if configured)
        if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' }}
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          S3_BASE_PATH: ${{ secrets.S3_BASE_PATH || '' }}
        run: |
          BASE_PATH="${S3_BASE_PATH:+${S3_BASE_PATH}/}"
          aws cloudfront create-invalidation \
            --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} \
            --paths "/${BASE_PATH}latest/*" "/${BASE_PATH}${{ steps.version.outputs.version }}/*"

      - name: Output deployment info
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_BASE_PATH: ${{ secrets.S3_BASE_PATH || '' }}
          CDN_DOMAIN: ${{ secrets.CDN_DOMAIN || '' }}
        run: |
          BASE_PATH="${S3_BASE_PATH:+${S3_BASE_PATH}/}"
          if [ -n "$CDN_DOMAIN" ]; then
            BASE_URL="https://${CDN_DOMAIN}/${BASE_PATH}"
          else
            BASE_URL="https://${S3_BUCKET}.s3.amazonaws.com/${BASE_PATH}"
          fi
          
          echo "âœ… Package built and deployed to S3"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Bucket: ${S3_BUCKET}"
          echo ""
          echo "ðŸ“¦ Versioned URLs:"
          echo "  JS: ${BASE_URL}${{ steps.version.outputs.version }}/opencomments.js"
          echo "  CSS: ${BASE_URL}${{ steps.version.outputs.version }}/opencomments.css"
          echo ""
          echo "ðŸ”— Latest URLs:"
          echo "  JS: ${BASE_URL}latest/opencomments.js"
          echo "  CSS: ${BASE_URL}latest/opencomments.css"
          echo ""
          echo "ðŸ’» Usage:"
          echo "  <link rel=\"stylesheet\" href=\"${BASE_URL}latest/opencomments.css\">"
          echo "  <script src=\"${BASE_URL}latest/opencomments.js\"></script>"

